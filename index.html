<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <link rel="icon" type="image/svg+xml" href="https://rincynar.top/content/icon/favicon.png" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>File Index - RinCynar</title>
  <meta name="description" content="A Material You style file index and download page for the repository." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --primary:#6750a4;
      --radius:12px;
      font-family: 'Roboto', system-ui, -apple-system, 'Segoe UI', Roboto, 'Noto Sans', 'Helvetica Neue', Arial;
    }

    /* Light theme variables */
    :root[data-theme="light"]{
      --bg:#f6f7fb;
      --card:#ffffff;
      --on-card:#111827;
      --on-primary:#ffffff;
      --muted:#6b6b6b;
      --text:#111827;
    }

    /* Dark theme variables (default) */
    :root[data-theme="dark"], :root:not([data-theme]){
      --bg:#071025;
      --card:#0f1724;
      --on-card:#e6eef8;
      --on-primary:#ffffff;
      --muted:#9aa6bf;
      --text:#e6eef8;
    }

    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#071025);color:var(--text)}
    header{display:flex;align-items:center;gap:12px;padding:20px 24px}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#9a6df9);display:flex;align-items:center;justify-content:center;color:var(--on-primary);font-weight:700}
    h1{font-size:18px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

    main{padding:20px 24px}
    .search-row{display:flex;gap:12px;align-items:center;margin-bottom:16px}
    .search{flex:1;background:var(--card);color:var(--on-card);padding:10px 12px;border-radius:12px;box-shadow:0 1px 0 rgba(0,0,0,0.03);display:flex;gap:8px;align-items:center}
    .search input{border:0;outline:none;background:transparent;color:var(--on-card);font-size:14px;width:100%}
    .controls{display:flex;gap:8px}
    button.btn{border:0;padding:8px 12px;border-radius:10px;background:var(--primary);color:var(--on-primary);cursor:pointer;font-weight:500}
    button.ghost{background:transparent;color:var(--primary);border:1px solid rgba(255,255,255,0.06)}

    .card{background:var(--card);color:var(--on-card);border-radius:var(--radius);padding:12px;box-shadow:0 8px 20px rgba(0,0,0,0.12);}
    .list{margin-top:12px}
    .item{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;margin-bottom:8px}
    .item:hover{background:linear-gradient(90deg,rgba(103,80,164,0.04),transparent)}
    .icon{width:40px;height:40px;border-radius:8px;background:linear-gradient(135deg,#2b2540,#1b2230);display:flex;align-items:center;justify-content:center;color:var(--primary);font-weight:700}
    .meta{flex:1}
    .meta .title{font-size:14px;font-weight:500}
    .meta .sub{font-size:12px;color:var(--muted);} 
    .actions{display:flex;gap:8px}
    a.link{color:var(--primary);text-decoration:none;font-size:13px}

    .path{font-size:13px;color:var(--muted);margin-bottom:8px}

    footer{padding:20px 24px;color:var(--muted);font-size:13px}

    .empty{padding:40px;text-align:center;color:var(--muted)}

    @media (max-width:600px){ header{padding:12px} main{padding:12px} }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">dl</div>
      <div>
        <h1>File Index</h1>
        <p class="lead">Browse, preview and download repository files â€” Material You style</p>
      </div>
    </div>
  </header>

  <main>
    <div class="card">
      <div class="search-row">
        <div class="search" role="search">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.6"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input id="q" placeholder="Search filenames (Enter or live filter)">
          <div style="width:8px"></div>
        </div>
        <div class="controls">
          <button id="refresh" class="btn">Refresh</button>
          <button id="toggle-github" class="ghost">GitHub API</button>
          <button id="theme-toggle" class="ghost">Theme</button>
        </div>
      </div>
      <div class="path" id="current-path">/</div>
      <div id="list" class="list"></div>
      <div id="empty" class="empty" style="display:none">No files or directories found</div>
    </div>

    <div style="height:12px"></div>
    <div class="card" style="padding:12px 16px">
      <strong>Notes:</strong>
      <ul style="margin:8px 0 0 18px;padding:0;color:var(--muted)">
        <li>By default the page lists repository contents via the GitHub API (public repos).</li>
        <li>For private repos or offline use, place a `file-index.json` at the site root (generated by the included Node script).</li>
        <li>Download links point to raw.githubusercontent.com (works for GitHub-hosted repos).</li>
      </ul>
    </div>
  </main>

  <footer>
    <div>Repository: <code>RinCynar/dl</code> Â· Branch: <code>main</code></div>
  </footer>

  <script>
    // Basic configuration â€” edit to adapt to another repository
    const OWNER = 'RinCynar';
    const REPO = 'dl';
    const BRANCH = 'main';

    // State
    let useGithubApi = true; // can switch to local file-index.json
    let cache = {};
    let currentPath = '';

    const qEl = document.getElementById('q');
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');
    const pathEl = document.getElementById('current-path');
    const refreshBtn = document.getElementById('refresh');
    const toggleBtn = document.getElementById('toggle-github');
    const themeBtn = document.getElementById('theme-toggle');

    function setPath(p){ currentPath = p.replace(/^\/+|\/+$/g,''); pathEl.textContent = '/' + (currentPath||''); }

    function toRawUrl(path){ return `https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/file/${path.split('/').map(encodeURIComponent).join('/')}` }
    function toGithubUrl(path){ return `https://github.com/${OWNER}/${REPO}/blob/${BRANCH}/file/${path.split('/').map(encodeURIComponent).join('/')}` }

    async function fetchGithubContents(path){
      const apiPath = 'file' + (path ? `/${path}` : '');
      const api = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${apiPath}?ref=${BRANCH}`;
      const res = await fetch(api);
      if(!res.ok) throw new Error('GitHub API error: ' + res.status);
      return await res.json();
    }

    async function fetchLocalIndex(){
      const res = await fetch('/file-index.json');
      if(!res.ok) throw new Error('file-index.json not found');
      return await res.json();
    }

    function renderList(items){
      listEl.innerHTML = '';
      if(!items || items.length===0){ emptyEl.style.display='block'; return }
      emptyEl.style.display='none';

      items.sort((a,b)=>{ // folders first
        if(a.type===b.type) return a.name.localeCompare(b.name);
        return a.type==='dir'?-1:1;
      });

      for(const it of items){
        const row = document.createElement('div'); row.className='item';
        const ic = document.createElement('div'); ic.className='icon';
        ic.textContent = it.type==='dir' ? 'ðŸ“' : (it.name.split('.').pop().slice(0,2).toUpperCase());
        const meta = document.createElement('div'); meta.className='meta';
        const title = document.createElement('div'); title.className='title';
        title.textContent = it.name;
        const sub = document.createElement('div'); sub.className='sub';
        if(it.type==='dir') sub.textContent = 'Directory';
        else sub.textContent = `${(it.size||0)} bytes Â· ${it.path||''}`;
        meta.appendChild(title); meta.appendChild(sub);

        const actions = document.createElement('div'); actions.className='actions';
        if(it.type==='dir'){
          const open = document.createElement('button'); open.className='ghost'; open.textContent='Open';
          open.onclick = ()=>{ navigate(it.path); };
          actions.appendChild(open);
        } else {
          const dl = document.createElement('a'); dl.className='btn'; dl.textContent='Download';
          dl.href = toRawUrl(it.path);
          dl.target = '_blank';
          dl.rel='noopener';
          actions.appendChild(dl);

          const view = document.createElement('a'); view.className='ghost'; view.textContent='GitHub';
          view.href = toGithubUrl(it.path);
          view.target='_blank'; view.rel='noopener';
          actions.appendChild(view);
        }

        row.appendChild(ic); row.appendChild(meta); row.appendChild(actions);
        listEl.appendChild(row);
      }
    }

    async function listPath(path){
      setPath(path||'');
      if(useGithubApi){
        try{
          const data = await fetchGithubContents(path||'');
          const items = data.map(d=>({
            name: d.name,
            type: d.type,
            path: d.path.startsWith('file/') ? d.path.substring(5) : d.path,
            size:d.size||0
          }));
          cache[(path||'')] = items;

          if (path) {
            const parentPath = path.lastIndexOf('/') > -1 ? path.substring(0, path.lastIndexOf('/')) : '';
            const upItem = { name: '..', type: 'dir', path: parentPath, size: 0 };
            renderList([upItem, ...items]);
          } else {
            renderList(items);
          }
          return;
        }catch(e){
          console.warn('GitHub API failed:',e);
        }
      }

      try{
        const idx = await fetchLocalIndex();
        const key = (path||'');
        const items = idx[key] || [];

        if (key) {
            const parentPath = key.lastIndexOf('/') > -1 ? key.substring(0, key.lastIndexOf('/')) : '';
            const upItem = { name: '..', type: 'dir', path: parentPath, size: 0 };
            renderList([upItem, ...items]);
        } else {
            renderList(items);
        }
        return;
      }catch(e){
        console.error('local index failed',e);
        listEl.innerHTML=''; emptyEl.style.display='block'; emptyEl.textContent='Unable to load file list: both GitHub API and file-index.json are unavailable.';
      }
    }

    function navigate(path){ listPath(path); }

    // Search / filter
    function applyFilter(){
      const q = (qEl.value||'').toLowerCase();
      if(!q){ // show cached current
        if(cache[currentPath||'']) renderList(cache[currentPath||'']);
        return;
      }
      const items = (cache[currentPath||'']||[]).filter(it=> (it.name||'').toLowerCase().includes(q) || (it.path||'').toLowerCase().includes(q));
      renderList(items);
    }

    qEl.addEventListener('input', ()=>{ applyFilter(); });
    qEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter') applyFilter(); });

    refreshBtn.addEventListener('click', ()=>{ cache={}; listPath(currentPath); });
    toggleBtn.addEventListener('click', ()=>{ useGithubApi = !useGithubApi; toggleBtn.textContent = useGithubApi ? 'GitHub API' : 'local JSON'; cache={}; listPath(currentPath); });

    // Theme handling: default dark, persisted in localStorage
    function applyTheme(t){
      document.documentElement.setAttribute('data-theme', t);
      themeBtn.textContent = t === 'dark' ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('theme', t);
    }
    themeBtn.addEventListener('click', ()=>{
      const current = localStorage.getItem('theme') || 'dark';
      const next = current === 'dark' ? 'light' : 'dark';
      applyTheme(next);
    });

    // Initial load
    (async ()=>{
      // set theme (default dark)
      const saved = localStorage.getItem('theme') || 'dark';
      applyTheme(saved);
      toggleBtn.textContent = useGithubApi ? 'GitHub API' : 'local JSON';
      await listPath('');
    })();

  </script>
</body>
</html>